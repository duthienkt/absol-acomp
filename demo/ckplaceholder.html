<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CKPlaceholder</title>
    <script src="../dist/absol-acomp.js?<?php  echo stat('../dist/absol-acomp.js')['mtime'];?>"></script>
    <script src="https://absol.cf/ckeditor/ckeditor.js"></script>
</head>
<body>
<style>
    html, body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    #ck {
        width: 100%;
        height: 100%;
        overflow: auto;
    }
</style>
<div id="ck"></div>
<script>
    var ck = absol.$('#ck');

    function render(o) {
        return absol._(o).addTo(ck);
    }
</script>

<script>

    function user_chose_variable(currentExpression) {
        var $ = absol.$;
        var _ = absol._;
        return new Promise(function (resolve) {
            var input = _({
                tag: 'selectmenu',
                props: {
                    items: [
                        { text: "Tên", value: 'first_name' },
                        { text: "Họ", value: 'last_name' },
                        { text: 'Tuổi', value: 'old' },
                        { text: 'Địa chỉ', value: 'address' }
                    ]
                }
            });
            input.value = currentExpression || '';
            var dialog = _({
                extendEvent: ['action'],
                class: 'as-message-dialog',
                child: [
                    {
                        class: 'as-message-dialog-header',
                        child: {
                            tag: 'span',
                            class: 'as-message-dialog-title',
                            child: { text: '' }
                        }
                    },
                    {
                        class: 'as-message-dialog-body',
                        child: [
                            '<label>Tên biến: </label>',
                            input
                        ]
                    },
                    {
                        class: 'as-message-dialog-footer',
                        child: [
                            {
                                tag: 'flexiconbutton',
                                class: ['as-message-dialog-no-btn', 'secondary'],
                                props: {
                                    text: 'Cancel'
                                },
                                on: {
                                    click: function () {
                                        modal.remove();
                                        resolve(null);
                                    }
                                }
                            },
                            {
                                tag: 'flexiconbutton',
                                class: ['as-message-dialog-yes-btn', 'primary'],
                                props: {
                                    text: 'ok'
                                },
                                on: {
                                    click: function () {
                                        modal.remove();
                                        if (input.value.trim().length > 0)
                                            resolve({ value: input.value.trim() });
                                    }
                                }
                            }
                        ]
                    }
                ]
            });

            var modal = _({ tag: 'modal', child: dialog }).addTo(document.body);
        })
            ;
    }

    render('<h2>CK Inline Short Text(Variable)</h2>');

    var shortExpressionInput = absol._({
        tag: 'ckinlineshorttext',
        props: {
            extensions: ['variable'],
            variables: {
                first_name: { text: "Tên" },
                last_name: { text: "Họ" },
                old: { text: 'Tuổi' },
                address: { text: 'Địa chỉ' }
            },
            removeToolbar: true
        },
        on: {
            focus: function () {
                // lastFocusHolder = this;
                // bt.disabled = false;
            },
            change: function () {
                absol.require('snackbar').show(this.data);
            },
            command: function (event) {
                var ck = this;//ckplaceholder
                switch (event.command) {
                    case 'insert_variable':
                        user_chose_variable(this.getSelectedVariable()).then(function (result) {
                            if (result) {
                                ck.insertVariable(result.value);//expression
                            }
                        });
                        break;
                }
            }
        }
    });

    shortExpressionInput.data = 'last_name + " "+ first_name + ", năm nay " + old + "tuổi"';


    var te = render('');


    function user_chose_expression(currentExpression) {
        var $ = absol.$;
        var _ = absol._;
        return new Promise(function (resolve) {
            var input = _('input');
            input.value = currentExpression || '';
            var dialog = _({
                extendEvent: ['action'],
                class: 'as-message-dialog',
                child: [
                    {
                        class: 'as-message-dialog-header',
                        child: {
                            tag: 'span',
                            class: 'as-message-dialog-title',
                            child: { text: '' }
                        }
                    },
                    {
                        class: 'as-message-dialog-body',
                        child: [
                            '<label>Biểu thức: </label>',
                            input
                        ]
                    },
                    {
                        class: 'as-message-dialog-footer',
                        child: [
                            {
                                tag: 'flexiconbutton',
                                class: ['as-message-dialog-no-btn', 'secondary'],
                                props: {
                                    text: 'Cancel'
                                },
                                on: {
                                    click: function () {
                                        modal.remove();
                                        resolve(null);
                                    }
                                }
                            },
                            {
                                tag: 'flexiconbutton',
                                class: ['as-message-dialog-yes-btn', 'primary'],
                                props: {
                                    text: 'ok'
                                },
                                on: {
                                    click: function () {
                                        modal.remove();
                                        if (input.value.trim().length > 0)
                                            resolve({ value: input.value.trim() });
                                    }
                                }
                            }
                        ]
                    }
                ]
            });

            var modal = _({ tag: 'modal', child: dialog }).addTo(document.body);
        });
    }

    var lastFocusHolder = null;
    var bt = render({
        tag: 'flexiconbutton',
        style: { height: '30px' },
        props: {
            text: 'Insert Expression',
            icon: 'span.mdi.mdi-code-json',
            disabled: true
        },
        on: {
            click: function () {
                var current = lastFocusHolder;
                var selectedExpression = current.getSelectedExpression();

                user_chose_expression(selectedExpression).then(function (result) {
                    if (result) {
                        current.insertExpression(result.value);//expression
                    }
                });
            }
        }
    });

    render('<h2>CK Inline Short Text(Expression)</h2>');
    var t = render('div');
    var shortInput = absol._({
        tag: 'ckinlineshorttext',
        props: {
            extensions: ['expression']
        },
        on: {
            focus: function () {
                lastFocusHolder = this;
                bt.disabled = false;
            },
            change: function () {
                textInput.value = this.data;
            },
            command: function (event) {
                var ck = this;//ckplaceholder
                switch (event.command) {
                    case 'insert_expression':
                        user_chose_expression(this.getSelectedExpression()).then(function (result) {
                            if (result) {
                                ck.insertExpression(result.value);//expression
                            }
                        });
                        break;
                }
            }
        }
    });

    var textInput = render({
        tag: 'input',
        style: {
            width: '100%',
            boxSizing: 'border-box',
            'margin-top': '10px'
        }
    });

    shortInput.data = 'Tôi là {{ my_name}}, năm nay tôi {{ year_old }}';

    setTimeout(function () {
        //don't care it, to prevent ckeditor trigger after html loaded
        te.selfReplace(shortExpressionInput);
        t.selfReplace(shortInput);
    }, 100)

    var myInfo = {
        name: "Phạm Hùng Quốc",
    };


    render('<h2>CK Placeholder</h2>');

    var host = {};
    var ckPlaceHolderElt = absol._({
        tag: 'ckplaceholder',
        props: {
            // config: {}//some config of CKEditor
            extensions: ['expression']
        },
        on: {
            focus: function () {
                lastFocusHolder = this;
                bt.disabled = false;
            },
            editorcreated: function () {
                var editor = this.editor;
                host.ckEditor = editor;

            },
            editorready: function () {

                console.log("Editor đã sẵn sàng");
            },
            change: function () {
                preview.innerHTML = this.data;
            },
            command: function (event) {
                var ck = this;//ckplaceholder
                switch (event.command) {
                    case 'insert_expression':
                        user_chose_expression(ck.getSelectedExpression()).then(function (result) {
                            if (result) {
                                ck.insertExpression(result.value);//expression
                            }
                        })
                        break;
                }
            }
        }
    });


    ckPlaceHolderElt.data = "Tôi năm nay <strong>{{ old }}<strong>";
    ck.appendChild(ckPlaceHolderElt);
    var preview = absol._({
        class: 'cke_contents_ltr'
    });
    ck.appendChild(preview);


</script>

<script>

    // CKEDITOR.stylesSet.add( 'default', [
    //     // Block Styles
    //     { name: 'Normal',       element: 'p',      styles: { } },
    //     { name: 'Note',       element: 'p',      styles: { 'color': 'Blue', padding:'5px', "background-color":'rgba(255, 100, 100, 0.5)', 'border-radius': '3px' } }
    // ] );
    //
    // CKEDITOR.config.format_tags = 'p;h1;h2;h3;h4;h5;h6;pre;address;div;blockquote';
    // CKEDITOR.config.format_blockquote = { element: 'blockquote', attributes: { 'class': 'editorCode' } };
    //
    //
    // CKEDITOR.addCss( '.cke_editable .note-background { background-color: #feddd6; padding: 15px }' );
    // CKEDITOR.plugins.add( 'notehighlight', {
    //     icons: 'notehighlight',
    //     init: function( editor ) {
    //         editor.addCommand( 'formatNoteHighlight', {
    //             exec: function( editor ) {
    //                 var style = new CKEDITOR.style( { element: 'p', attributes: { 'class': 'note-background' } } );
    //
    //                 if (style.checkActive( editor.elementPath(), editor )) {
    //                     editor.removeStyle( style );
    //                 } else {
    //                     editor.applyStyle( style );
    //                 }
    //
    //             }
    //         });
    //         editor.ui.addButton( 'NoteHighlight', {
    //             label: 'Highlight Note',
    //             command: 'formatNoteHighlight',
    //             toolbar: 'document'
    //         });
    //     }
    // });

</script>
</body>
</html>